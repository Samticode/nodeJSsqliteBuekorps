<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin</title>
</head>
<!-- ------------------------------------------------------------------------------------------------------------------------ -->

<style>
    /* ----------------Basic styles--------------------- */
    * {
        padding: 0;
        margin: 0;
        color: var(--black);
    }
    
    :root {
        --black: #1c1c1c;
        --brown: #4e4e56;
        --green: #A0AFA0;
        --white: #FDFDFD;
        --beigh: #D9D9D9;
        --red: #bd8989;
    }

    body {
        background-color: var(--green);
        overflow-y: hidden;
    }

    h1 {
        font-size: 3rem;
        margin: 3%;
        height: 115px;
        border-bottom: 3px solid var(--brown);
        cursor: pointer;
        transition: cubic-bezier(0.075, 0.82, 0.165, 1) 0.3s;
    }
    h1:hover {
        transform: scale(1.03);
    }

    h2 {
        font-size: 2rem;
        margin: 3% 3% 0;
    }

    main {
        height: 100vh;
        overflow-x: scroll;
        display: flex;
        gap: 1vw;
        place-items: center;
        position: relative;
        width: max-content;
    }
    .spacer {
        width: 100vw;
    }

    /* ----------------Company styles--------------------- */
    .companyDiv {
        position: relative;
        background-color: var(--white);
        height: 97vh;
        width: 500px;
        border: #4e4e56 solid 1px;
        overflow-y: scroll;
    }
    
    /* ----------------Leader styles--------------------- */
    .leader {
        background-color: var(--white);
        color: var(--black);
    }
    .leader > tbody > tr:hover {
        background-color: var(--white);
        cursor: default;
    }

    .leaderDiv {
        height: 135px;
        border-bottom: 2px solid var(--brown);
    }

    /* ----------------Peleton styles--------------------- */
    .peletonTitle{
        transition: cubic-bezier(0.075, 0.82, 0.165, 1) 0.3s;
        cursor: pointer;
    }

    .peletonTitle:hover {
        transform: scale(1.03);
    }

    .peletonDiv {
        border-bottom: 2px solid var(--brown);
    }

    table, td {
        border: 0.5px solid black;
        border-collapse: collapse;
        font-size: 1.5rem;
    }

    tbody > tr:hover{
        background-color: #b4c5b4;
        cursor: pointer;
    }

    table {
        background-color: var(--green);
        color: var(--white);
        width: 95%;
        margin: 0% auto 4%;
    }

    thead {
        font-weight: bold;
    }

    /* ----------------Create & assign styles--------------------- */
    .buttonDiv {
        position: fixed;
        bottom: 5%;
        z-index: 5;
        width: 100%;
        display: flex;
        justify-content: space-evenly;
    }
    .button {
        font-size: 1.5rem;
        padding: 2%;
        border-radius: 1vmax;
    }


    .createForm {
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);

        height: 50vh;
        width: 50vw;
        background-color: #4e4e56cc;

        display: grid;
        grid-template-columns: 1fr 1fr;
    }
    .assignMember, .assignLeader{
       width: 75vw; 
       grid-template-columns: 1fr 1fr 1fr;
    }
    .createForm > div{
        border: 0.5px solid var(--white);
    }
    .title {
        font-size: 3rem;
        color: var(--white);
    }
    label {
        color: var(--white);
        font-size: 2rem;
    }
    input {
        width: 100%;
        font-size: 2rem;
        margin: 0 auto;
    }

    .leaderTable, .companyTable, .memberTable, .allPeletonsTable, .allCompanyTable {
        background-color: var(--white);
    }

    /* ----------------Delete peleton company styles--------------------- */
    .deleteButton {
        font-size: 1.125rem;
        padding: 0% 2%;
        background-color: var(--red);
        margin-left: 2%;
    }

    /* ----------------Delete peleton company styles--------------------- */
    .editForm {
        position: fixed;
        top: 0;
        right: 0;

        width: 35vw;
        height: 100vh;
        background-color: #1c1c1cbd;
    }
    .editCompany {
        grid-template-rows: 1fr 2fr 3fr;
    }
</style>

<!-- ------------------------------------------------------------------------------------------------------------------------ -->

<body>
    <main>
    </main>
    <div style="display: none" class="createForm addCompanyForm">
        <div>
            <h2 class="title">Create New Company</h2>
            <form method="POST" action="/createCompany">
                <br>
                <br>
                <label for="companyName">Company Name</label require>
                    <br>
                <input type="text" name="companyName" id="companyName">
                    <br>
                    <br>
                <label for="leaderId">Leader ID</label require>
                    <br>
                <input type="number" name="leaderId" id="leadleaderIderName">
                    <br>
                    <br>
                <input type="submit" value="create">
            </form>
        </div>
        <div>
            <h2 class="title">Leaders</h2>
            <table class="leaderTable">
                <thead><tr>
                    <td>ID</td>
                    <td>Leader Name</td>
                </tr></thead>
                <tbody id="leaderTbody">
                </tbody>
            </table>
        </div>
    </div>
    <div style="display: none" class="createForm addPeletonForm">
        <div>
            <h2 class="title">Create New Peleton</h2>
            <form method="POST" action="/createPeleton">
                <br>
                <br>
                <label for="peletonName">Peleton Name</label>
                    <br>
                <input type="text" name="peletonName" id="peletonName">
                    <br>
                    <br>
                <label for="companyId">Company ID</label>
                    <br>
                <input type="number" name="companyId" id="companyId">
                    <br>
                    <br>
                <input type="submit" value="create">
            </form>
        </div>
        <div>
            <h2 class="title">Companies</h2>
            <table class="companyTable">
                <thead><tr>
                    <td>ID</td>
                    <td>Company Name</td>
                </tr></thead>
                <tbody id="companyTbody">
                </tbody>
            </table>
        </div>
    </div>
    <div style="display: none" class="createForm assignMember">
        <div>
            <h2 class="title">Assign Members</h2>
            <form method="POST" action="/assignMember">
                <br>
                <br>
                <label for="peletonId">Peleton ID</label>
                <br>
                <input type="number" name="peletonId" id="peletonId">
                <br>
                <br>
                <label for="memberId">User ID</label>
                <br>
                <input type="number" name="memberId" id="memberId">
                <input type="hidden" name="source" value="admin">
                <br>
                <br>
                <input type="submit" value="assign">
            </form>
        </div>
        <div>
            <h2 class="title">Free Members</h2>
            <table class="memberTable">
                <thead><tr>
                    <td>ID</td>
                    <td>Username</td>
                </tr></thead>
                <tbody id="memberTable">
                </tbody>
            </table>
        </div>
        <div>
            <h2 class="title">All Peletons</h2>
            <table class="allPeletonsTable">
                <thead><tr>
                    <td>ID</td>
                    <td>Peleton Name</td>
                    <td>Company Name</td>
                </tr></thead>
                <tbody id="allPeletonsTable">
                </tbody>
            </table>
        </div>
    </div>
    <div style="display: none" class="createForm assignLeader">
        <div>
            <h2 class="title">Assign Leaders</h2>
            <form action="/assignLeader" method="post">
                <br>
                <br>
                <label for="leaderId">Leader ID</label>
                <br>
                <input type="number" name="leaderId" id="leaderId">
                <br>
                <br>
                <label for="companyId">Company ID</label>
                <br>
                <input type="number" name="companyId" id="companyId">
                <br>
                <br>
                <input type="submit" value="assign">
            </form>
        </div>
        <div>
            <h2 class="title">Leaders</h2>
            <table class="leaderTable">
                <thead><tr>
                    <td>ID</td>
                    <td>Leader Name</td>
                </tr></thead>
                <tbody id="leaderTbody">
                </tbody>
            </table>
        </div>
        <div>
            <h2 class="title">Companies</h2>
            <table class="allCompanyTable">
                <thead><tr>
                    <td>ID</td>
                    <td>Company Name</td>
                </tr></thead>
                <tbody id="allCompanyTbody">
                </tbody>
            </table>
        </div>
    </div>

    <div style="display: none" class="editForm editCompany">
        <h2 class="title">Edit Company/leader</h2>
        <form method="POST" action="/editCompany?_method=PUT">
            <label for="companyId">Company ID</label>
            <br>
            <input type="text" name="companyId" id="editCompanyId" value="" readonly>
            <br>
            <br>
            <br>
            <label for="companyName">Company Name</label>
            <br>
            <input type="text" name="companyName" id="editCompanyName" value="">
            <br>    
            <br>
            <br>
            <label for="leaderId">Leader ID</label>
            <br>
            <input type="number" name="leaderId" id="editLeaderId" value="">
            <br>
            <br>
            <label for="leaderMail">Leader mail</label>
            <br>
            <input type="text" name="leaderMail" id="editLeaderMail" value="">
            <br>
            <br>
            <input type="submit" value="edit">
        </form> 
        <div>
            <h2 class="title">Leaders</h2>
            <table class="leaderTable">
                <thead><tr>
                    <td>ID</td>
                    <td>Leader Name</td>
                </tr></thead>
                <tbody id="leaderTbody">
                </tbody>
            </table>
        </div>
    </div>
    <div style="display: none;" class="editForm editPeleton">
        <h2 class="title">Edit Peleton</h2>
        <form method="POST" action="/editPeleton?_method=PUT">
            <label for="editPeletonId">Peleton Id</label>
            <input type="number" id="editPeletonId" name="editPeletonId" readonly>
            <br>
            <br>
            <br>
            <label for="editPeletonName">Peleton Name</label>
            <input type="text" id="editPeletonName" name="editPeletonName">
            <br>
            <br>
            <br>
            <input type="submit" value="edit">
        </form> 
    </div>
    <div style="display: none" class="editForm editMember">
        <h2 class="title">Edit Peleton</h2>
        <form method="POST" action="/editMember?_method=PUT">
            <label for="editMemberId">Member Id</label>
            <input type="number" id="editMemberId" name="editMemberId" readonly>
            <br>
            <br>
            <br>
            <label for="editMemberName">Member Name</label>
            <input type="text" id="editMemberName" name="editMemberName">
            <br>
            <br>
            <br>
            <label for="editMemberMail">Member Mail</label>
            <input type="text" id="editMemberMail" name="editMemberMail">
            <br>
            <br>
            <br>
            <label for="editMemberPeleton">Member Peleton</label>
            <input type="text" id="editMemberPeleton" name="editMemberPeleton">
            <br>
            <br>
            <br>
            <input type="submit" value="edit">
        </form> 
    </div>


    <div class="buttonDiv">
        <button class="button btnFirst">Create New Company</button>
        <button class="button btnSecond">Create New Peleton</button>
        <button class="button btnThird">Assign Members</button>
        <button class="button btnFourth">Assign Leaders</button>
    </div>
</body>

<!-- ------------------------------------------------------------------------------------------------------------------------ -->

<script defer>
    let editCompany = document.querySelector('.editCompany');
    let editPeleton = document.querySelector('.editPeleton');
    let editMember = document.querySelector('.editMember');
    
    async function createCompanyStructure() {
        const response = await fetch('/api/users');
        const users = await response.json();
        
        const companies = {};
        
        users.forEach(user => {
            if (!companies[user.company_name]) {
                companies[user.company_name] = { id: user.company_id, leader: null, peletons: {} };
            }

            companies[user.company_name].leader = { id: user.leader_id, name: user.leader_name, email: user.leader_email };
            
            if (!companies[user.company_name].peletons[user.peleton_name]) {
                companies[user.company_name].peletons[user.peleton_name] = { id: user.peleton_id, users: [] };
            }
            
            companies[user.company_name].peletons[user.peleton_name].users.push({ id: user.user_id, username: user.username, email: user.email });
        });
        console.log(companies);

        const mainElement = document.querySelector('main');

        for (const companyName in companies) {
            const companyDiv = document.createElement('div');
            companyDiv.className = 'companyDiv';
            
            const deleteButton = document.createElement('button');
            deleteButton.textContent = 'Delete Company';
            deleteButton.className = 'deleteButton';

            deleteButton.addEventListener('click', async () => {
                let confirmation = confirm('Are you sure you want to delete this?');
                if (confirmation) {
                    let companyID = companies[companyName].id;
                    const response = await fetch(`/deleteCompany/${companyID}`, {
                        method: 'DELETE'
                    });
                    window.location.href = '/main/admin';
                } else {
                    event.preventDefault();
                }
            });
            
            companyDiv.appendChild(deleteButton);
            
            const companyTitle = document.createElement('h1');
            companyTitle.textContent = `${companyName} (ID: ${companies[companyName].id})`;
            companyTitle.addEventListener('click', () => {
                let editCompanyId = document.getElementById('editCompanyId');
                let editCompanyName = document.getElementById('editCompanyName');
                let editLeaderId = document.getElementById('editLeaderId');
                let editLeaderMail = document.getElementById('editLeaderMail');

                editCompanyId.value = companies[companyName].id;
                editCompanyName.value = companyName;
                editLeaderId.value = companies[companyName].leader.id;
                editLeaderMail.value = companies[companyName].leader.email;
                
                showForm(editCompany);
            });
            companyDiv.appendChild(companyTitle);
            
            const leaderDiv = document.createElement('div');
            leaderDiv.className = 'leaderDiv';
            
            const leaderTitle = document.createElement('h2');
            leaderTitle.textContent = 'Leader';
            leaderDiv.appendChild(leaderTitle);

            const deleteLeaderButton = document.createElement('button');
            deleteLeaderButton.textContent = 'Delete Leader';
            deleteLeaderButton.className = 'deleteButton';
            deleteLeaderButton.addEventListener('click', async () => {
                let confirmation = confirm('Are you sure you want to delete this?');
                if (confirmation) {
                    let leaderID = companies[companyName].leader.id;
                    const response = await fetch(`/deleteUser/${leaderID}`, {
                        method: 'DELETE'
                    });
                    window.location.href = '/main/admin';
                } else {
                    event.preventDefault();
                }

            });
            leaderDiv.appendChild(deleteLeaderButton);

            const leaderTable = document.createElement('table');
            leaderTable.className = 'leader';

            const leaderThead = document.createElement('thead');
            const leaderTr = document.createElement('tr');
            const leaderIdHeader = document.createElement('td');
            leaderIdHeader.textContent = 'ID';
            const leaderNameHeader = document.createElement('td');
            leaderNameHeader.textContent = 'Leader Name';
            leaderTr.appendChild(leaderIdHeader);
            leaderTr.appendChild(leaderNameHeader);
            leaderThead.appendChild(leaderTr);
            leaderTable.appendChild(leaderThead);

            const leaderTbody = document.createElement('tbody');
            const leaderUserTr = document.createElement('tr');
            const leaderIdCell = document.createElement('td');
            leaderIdCell.textContent = companies[companyName].leader.id;
            const leaderNameCell = document.createElement('td');
            leaderNameCell.textContent = companies[companyName].leader.name;
            leaderUserTr.appendChild(leaderIdCell);
            leaderUserTr.appendChild(leaderNameCell);
            leaderTbody.appendChild(leaderUserTr);
            leaderTable.appendChild(leaderTbody);

            leaderDiv.appendChild(leaderTable);
            companyDiv.appendChild(leaderDiv);

            const peletonDiv = document.createElement('div');
            peletonDiv.className = 'peletonDiv';

            for (const peletonName in companies[companyName].peletons) {
                const peletonTitle = document.createElement('h2');
                peletonTitle.className = 'peletonTitle';
                peletonTitle.textContent = `${peletonName} (ID: ${companies[companyName].peletons[peletonName].id})`;
                peletonTitle.addEventListener('click', () => {
                    let editPeletonId = document.getElementById('editPeletonId');
                    let editPeletonName = document.getElementById('editPeletonName');

                    editPeletonId.value = companies[companyName].peletons[peletonName].id;
                    editPeletonName.value = peletonName;

                    showForm(editPeleton);
                });
                peletonDiv.appendChild(peletonTitle);

                const deletePeletonButton = document.createElement('button');
                deletePeletonButton.textContent = 'Delete Peleton';
                deletePeletonButton.className = 'deleteButton';
                deletePeletonButton.addEventListener('click', async () => {
                    let confirmation = confirm('Are you sure you want to delete this?');
                    if (confirmation) {
                        let peletonID = companies[companyName].peletons[peletonName].id;
                        const response = await fetch(`/deletePeleton/${peletonID}`, {
                            method: 'DELETE'
                        });
                        window.location.href = '/main/admin';
                    } else {
                        event.preventDefault();
                    }
                });
                peletonDiv.appendChild(deletePeletonButton);

                const peletonTable = document.createElement('table');
                peletonTable.className = 'peleton';

                const peletonThead = document.createElement('thead');
                const peletonTr = document.createElement('tr');
                const peletonIdHeader = document.createElement('td');
                peletonIdHeader.textContent = 'ID';
                const peletonUsernameHeader = document.createElement('td');
                peletonUsernameHeader.textContent = 'Username';
                peletonTr.appendChild(peletonIdHeader);
                peletonTr.appendChild(peletonUsernameHeader);
                peletonThead.appendChild(peletonTr);
                peletonTable.appendChild(peletonThead);

                const peletonTbody = document.createElement('tbody');
                
                companies[companyName].peletons[peletonName].users.forEach(user => {
                    const peletonUserTr = document.createElement('tr');
                    peletonUserTr.addEventListener('click', () => {
                        let editMemberId = document.getElementById('editMemberId');
                        let editMemberName = document.getElementById('editMemberName');
                        let editMemberMail = document.getElementById('editMemberMail');
                        let editMemberPeleton = document.getElementById('editMemberPeleton');

                        editMemberId.value = user.id;
                        editMemberName.value = user.username;
                        editMemberMail.value = user.email;
                        editMemberPeleton.value = companies[companyName].peletons[peletonName].id;
                        showForm(editMember);
                    });
                    const peletonIdCell = document.createElement('td');
                    peletonIdCell.textContent = user.id;
                    const peletonUsernameCell = document.createElement('td');
                    peletonUsernameCell.textContent = user.username;
                    peletonUserTr.appendChild(peletonIdCell);
                    peletonUserTr.appendChild(peletonUsernameCell);

                    const deleteUserButton = document.createElement('button');
                    deleteUserButton.textContent = 'Delete User';
                    deleteUserButton.className = 'deleteButton';
                    deleteUserButton.addEventListener('click', async () => {
                        let confirmation = confirm('Are you sure you want to delete this?');
                        if (confirmation) {
                            let userID = user.id;
                            const response = await fetch(`/deleteUser/${userID}`, {
                                method: 'DELETE'
                            });
                            window.location.href = '/main/admin';
                        } else {
                            event.preventDefault();
                        }

                    });
                    peletonUserTr.appendChild(deleteUserButton);

                    peletonTbody.appendChild(peletonUserTr);
                });
                peletonTable.appendChild(peletonTbody);

                peletonDiv.appendChild(peletonTable);
            }

            companyDiv.appendChild(peletonDiv);
            mainElement.appendChild(companyDiv);
        }
        let spacer = document.createElement('div');
        spacer.className = 'spacer';
        mainElement.appendChild(spacer);
    }
    createCompanyStructure();

// ----------------------------------------------------------------

    const btnFirst = document.querySelector('.btnFirst');
    const btnSecond = document.querySelector('.btnSecond');
    const btnThird = document.querySelector('.btnThird');
    const btnFourth = document.querySelector('.btnFourth');

    const addCompanyForm = document.querySelector('.addCompanyForm');
    const addPeletonForm = document.querySelector('.addPeletonForm');
    const assignMember = document.querySelector('.assignMember');
    const assignLeader = document.querySelector('.assignLeader');

    const forms = [addCompanyForm, addPeletonForm, assignMember, assignLeader, editCompany, editPeleton, editMember];
    let currentForm = null;

    function hideAllForms() {
        forms.forEach(form => form.style.display = 'none');
    }

    function showForm(form) {
        if (currentForm === form) {
            form.style.display = 'none';
            currentForm = null;
        } else {
            hideAllForms();
            form.style.display = 'grid';
            currentForm = form;
        }
    }

    btnFirst.addEventListener('click', () => showForm(addCompanyForm));
    btnSecond.addEventListener('click', () => showForm(addPeletonForm));
    btnThird.addEventListener('click', () => showForm(assignMember));
    btnFourth.addEventListener('click', () => showForm(assignLeader));

// ----------------------------------------------------------------

    async function fillLeaderTable() {
        const leaderTables = document.querySelectorAll('#leaderTbody');
        
        const response = await fetch('/api/leaders');
        const leaders = await response.json();
        
        for (const leaderTable of leaderTables) {
            for (const leader of leaders) {
                const row = document.createElement('tr');

                const idCell = document.createElement('td');
                idCell.textContent = leader.user_id;
                row.appendChild(idCell);

                const nameCell = document.createElement('td');
                nameCell.textContent = leader.username;
                row.appendChild(nameCell);

                leaderTable.appendChild(row);
            }
        }
    };
    fillLeaderTable();

    async function fillCompanyTable() {
        const companyTable = document.querySelector('#allCompanyTbody');
        
        const response = await fetch('/api/freeCompanys');
        const companys = await response.json();

        for (const company of companys) {
            const row = document.createElement('tr');

            const idCell = document.createElement('td');
            idCell.textContent = company.company_id;
            row.appendChild(idCell);

            const nameCell = document.createElement('td');
            nameCell.textContent = company.name;
            row.appendChild(nameCell);

            companyTable.appendChild(row);
        }
    };
    fillCompanyTable();

    async function fillMemberTable() {
        const memberTable = document.querySelector('#memberTable');
        
        const response = await fetch('/api/freeMembers');
        const members = await response.json();

        for (const member of members) {
            const row = document.createElement('tr');

            const idCell = document.createElement('td');
            idCell.textContent = member.user_id;
            row.appendChild(idCell);

            const nameCell = document.createElement('td');
            nameCell.textContent = member.username;
            row.appendChild(nameCell);

            memberTable.appendChild(row);
        }
    };
    fillMemberTable();

    async function fillAllPeletonsTable() {
        const allPeletonsTable = document.querySelector('#allPeletonsTable');

        const response = await fetch('/api/peletons');
        const peletons = await response.json();

        for (const peleton of peletons) {
            const row = document.createElement('tr');

            const idCell = document.createElement('td');
            idCell.textContent = peleton.peleton_id;
            row.appendChild(idCell);

            const peletonNameCell = document.createElement('td');
            peletonNameCell.textContent = peleton.peleton_name;
            row.appendChild(peletonNameCell);

            const companyNameCell = document.createElement('td');
            companyNameCell.textContent = peleton.company_name;
            row.appendChild(companyNameCell);

            allPeletonsTable.appendChild(row);
        }
    }
    fillAllPeletonsTable()

    async function fillAllCompanyTable() {
        const allCompanyTable = document.querySelector('#companyTbody');

        const response = await fetch('/api/companys');
        const companys = await response.json();

        for (const company of companys) {
            const row = document.createElement('tr');

            const idCell = document.createElement('td');
            idCell.textContent = company.company_id;
            row.appendChild(idCell);

            const companyNameCell = document.createElement('td');
            companyNameCell.textContent = company.company_name;
            row.appendChild(companyNameCell);

            allCompanyTable.appendChild(row);
        }
    }
    fillAllCompanyTable()
</script>

<!-- ------------------------------------------------------------------------------------------------------------------------ -->

</html>
